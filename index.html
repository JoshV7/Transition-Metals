<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transition Metal Colour Match</title>
  <style>
    /* Dark theme base */
    body {
      margin: 0;
      background-color: #121212;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 1rem;
      text-align: center;
      font-weight: 700;
      font-size: 1.8rem;
      border-bottom: 1px solid #333;
    }

    main {
      flex: 1;
      padding: 0.5rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
    }

    #top-controls {
      width: 100%;
      max-width: 700px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    #feedback {
      flex: 1 1 300px;
      font-size: 1.1rem;
      font-weight: 600;
      color: lightgreen;
      user-select: none;
    }

    #score-time {
      flex: 0 0 auto;
      font-weight: 700;
      font-size: 1.1rem;
      color: #ccc;
      white-space: nowrap;
      user-select: none;
    }

    .btn-group {
      flex: 0 0 auto;
      display: flex;
      gap: 0.5rem;
    }

    button {
      background-color: #388e3c;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      min-width: 80px;
    }

    button:hover:not(:disabled) {
      background-color: #2e7d32;
    }

    button:disabled {
      background-color: #444;
      color: #aaa;
      cursor: default;
    }

    button#show-answer {
      background-color: #d32f2f;
    }

    button#show-answer:hover:not(:disabled) {
      background-color: #b71c1c;
    }

    button#try-again {
      background-color: #00cc66;
    }

    button#try-again:hover {
      background-color: #00994d;
    }

    #ion {
      margin: 0.5rem 0 1rem;
      font-weight: 700;
      font-size: 1.5rem;
      background-color: #1976d2;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      cursor: grab;
      user-select: none;
      width: fit-content;
      align-self: center;
      text-align: center;
      min-width: 200px;
    }

    #ion.dragging {
      opacity: 0.6;
      cursor: grabbing;
    }

    #ion.selected {
      box-shadow: 0 0 15px 3px #4caf50;
      background-color: #2e7d32;
      cursor: pointer;
    }

    #dropzones {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 0.8rem;
      width: 100%;
      max-width: 700px;
      /* allow vertical scroll if needed */
      overflow-y: auto;
    }

    .dropzone {
      aspect-ratio: 1 / 1; /* square */
      border-radius: 8px;
      padding: 0.7rem 0.5rem;
      text-align: center;
      font-weight: 600;
      color: black;
      border: 2px solid #666;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      cursor: pointer;
      background-color: #888;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.1;
      max-width: 100%;
      box-sizing: border-box;
    }

    .dropzone.drag-over,
    .dropzone.active {
      transform: scale(1.1);
      border-color: #fff;
      box-shadow: 0 0 8px 2px #fff;
      z-index: 2;
    }

    footer {
      text-align: right;
      padding: 0.5rem 1rem 1rem;
      color: #888;
      font-weight: 600;
      user-select: none;
    }

    @media (max-width: 480px) {
      #ion {
        font-size: 1.2rem;
        padding: 0.4rem 0.8rem;
        min-width: 160px;
      }

      #feedback {
        font-size: 1rem;
        flex-basis: 100%;
      }

      .btn-group {
        width: 100%;
        justify-content: center;
        margin-top: 0.3rem;
      }

      #dropzones {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        max-width: 100%;
        gap: 0.6rem;
        overflow-y: visible;
      }

      .dropzone {
        font-size: 0.8rem;
        height: auto;
        min-height: 80px;
        aspect-ratio: auto; /* allow flexible height on mobile */
        white-space: normal;
        word-wrap: break-word;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>Transition Metal Colour Match</header>
  <main>
    <div id="top-controls" aria-live="polite" aria-atomic="true">
      <div id="feedback" role="alert" aria-live="assertive" aria-atomic="true"></div>
      <div id="score-time">Score: 0 / 0 | Time: 0s</div>
      <div class="btn-group">
        <button id="show-answer">Show Answer</button>
        <button id="next" disabled>Next</button>
        <button id="try-again" style="display:none;">Try Again</button>
      </div>
    </div>

    <div id="ion" draggable="true" tabindex="0" aria-grabbed="false"></div>
    <div id="dropzones" role="list"></div>
  </main>
  <footer>by Josh</footer>

  <script>
    const species_colours = {
      "[Cu(H₂O)₆]²⁺": "Pale blue solution",
      "Cu(OH)₂": "Pale blue precipitate",
      "[Cu(NH₃)₄(H₂O)₂]²⁺": "Dark blue solution",
      "CuCl₄²⁻": "Yellow solution",
      "CuI": "White precipitate",
      "Cu": "Brown solid",
      "[Cr(H₂O)₆]³⁺": "Pale purple solution",
      "Cr(OH)₃": "Dark green precipitate",
      "[Cr(NH₃)₆]³⁺": "Purple solution",
      "[Cr(OH)₆]³⁻": "Dark green solution",
      "Cr₂O₇²⁻": "Orange solution",
      "CrO₄²⁻": "Yellow solution",
      "[Fe(H₂O)₆]³⁺": "Yellow solution",
      "Fe(OH)₃": "Orange-brown precipitate",
      "[Fe(H₂O)₆]²⁺": "Pale green solution",
      "Fe(OH)₂": "Dark green precipitate",
      "CoCl₄²⁻": "Blue solution",
      "[Mn(H₂O)₆]²⁺": "Pale pink solution",
      "Mn(OH)₂": "Pale brown precipitate"
    };

    const colour_visuals = {
      "Pale blue solution": "#00BFFF",
      "Pale blue precipitate": "#00BFFF",
      "Dark blue solution": "#00008b",
      "Yellow solution": "#ffff00",
      "White precipitate": "#ffffff",
      "Brown solid": "#8b4513",
      "Pale purple solution": "#da70d6",
      "Dark green precipitate": "#006400",
      "Purple solution": "#4b0082",
      "Dark green solution": "#006400",
      "Orange solution": "#ff8c00",
      "Orange-brown precipitate": "#b8860b",
      "Pale green solution": "#98fb98",
      "Blue solution": "#1e90ff",
      "Pale pink solution": "#e6e6fa",
      "Pale brown precipitate": "#bdb76b"
    };

  const ionEl = document.getElementById('ion');
  const dropzonesEl = document.getElementById('dropzones');
  const feedbackEl = document.getElementById('feedback');
  const scoreTimeEl = document.getElementById('score-time');
  const showAnswerBtn = document.getElementById('show-answer');
  const nextBtn = document.getElementById('next');
  const tryAgainBtn = document.getElementById('try-again');

  let species = Object.keys(species_colours);
  let currentIndex = 0;
  let score = 0;
  let questionsAnswered = 0;
  let gameOver = false;
  let answered = false; // To lock dragging after answer
  let startTime;
  let totalStartTime;
  let totalElapsedInterval;
  let ionSelectedForSnap = false;

  // Shuffle helper
  function shuffle(array) {
    for(let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  // Setup dropzones with unique colours
  function setupDropzones() {
    dropzonesEl.innerHTML = '';
    let uniqueColours = [...new Set(Object.values(species_colours))];
    shuffle(uniqueColours);
    uniqueColours.forEach(colour => {
      const box = document.createElement('div');
      box.className = 'dropzone';
      box.textContent = colour;
      box.style.backgroundColor = colour_visuals[colour] || '#555';
      box.setAttribute('data-colour', colour);
      box.setAttribute('tabindex', '0');

      box.addEventListener('dragover', e => {
        e.preventDefault();
        box.classList.add('drag-over');
      });
      box.addEventListener('dragleave', e => {
        box.classList.remove('drag-over');
      });
      box.addEventListener('drop', e => {
        e.preventDefault();
        box.classList.remove('drag-over');
        if(gameOver || answered) return;  // lock after answer
        checkAnswer(box.getAttribute('data-colour'));
      });

      box.addEventListener('click', e => {
        if(gameOver || answered) return;

        if (ionSelectedForSnap) {
          // Ion is selected, treat this click as answer attempt
          checkAnswer(box.getAttribute('data-colour'));
          ionSelectedForSnap = false;
          ionEl.classList.remove('selected');
          dropzonesEl.childNodes.forEach(dz => dz.classList.remove('active'));
        } else {
          // Toggle active glow on dropzone
          if (box.classList.contains('active')) {
            box.classList.remove('active');
          } else {
            dropzonesEl.childNodes.forEach(dz => dz.classList.remove('active'));
            box.classList.add('active');
          }
        }
      });

      dropzonesEl.appendChild(box);
    });
  }

  // Set current ion text and reset styles
  function setCurrentIon() {
    ionEl.textContent = species[currentIndex];
    ionEl.setAttribute('aria-grabbed', 'false');
    ionEl.classList.remove('dragging');
    ionEl.classList.remove('selected');
    ionEl.setAttribute('draggable', 'true'); // enable dragging again
    feedbackEl.textContent = '';
    feedbackEl.style.color = 'lightgreen';
    showAnswerBtn.disabled = false;
    nextBtn.disabled = true;
    answered = false;  // unlock dragging
    ionSelectedForSnap = false;
    startTime = Date.now(); // start timer for this question
    if(!totalStartTime) {
      totalStartTime = Date.now();
      startTotalElapsedTimer();
    }
    updateScoreTime();
    ionEl.style.display = 'inline-block'; // ensure visible
  }

  // Drag event handlers
  ionEl.addEventListener('dragstart', (e) => {
    if(answered) {
      e.preventDefault();  // block dragging if already answered
      return;
    }
    ionEl.classList.add('dragging');
    ionEl.setAttribute('aria-grabbed', 'true');
  });

  ionEl.addEventListener('dragend', (e) => {
    ionEl.classList.remove('dragging');
    ionEl.setAttribute('aria-grabbed', 'false');
  });

  // Click on ion selects it for snap mode on mobile
  ionEl.addEventListener('click', e => {
    if(gameOver || answered) return;
    if(ionSelectedForSnap) {
      // Deselect if already selected
      ionSelectedForSnap = false;
      ionEl.classList.remove('selected');
      dropzonesEl.childNodes.forEach(dz => dz.classList.remove('active'));
    } else {
      ionSelectedForSnap = true;
      ionEl.classList.add('selected');
    }
  });

  // Check answer correctness
  function checkAnswer(selectedColour) {
    if(gameOver || answered) return;
    const endTime = Date.now();
    const timeTaken = Math.round((endTime - startTime) / 1000);
    const correctColour = species_colours[species[currentIndex]];
    questionsAnswered++;
    showAnswerBtn.disabled = true;
    ionEl.setAttribute('draggable', 'false');  // disable dragging after answer
    answered = true;
    ionSelectedForSnap = false;
    ionEl.classList.remove('selected');
    dropzonesEl.childNodes.forEach(dz => dz.classList.remove('active'));

    if(selectedColour === correctColour) {
      feedbackEl.textContent = `✅ Correct! ${species[currentIndex]} is a ${selectedColour}`;
      feedbackEl.style.color = 'lightgreen';
      score++;
    } else {
      feedbackEl.textContent = `❌ Wrong! ${species[currentIndex]} is a ${correctColour}, not a ${selectedColour}`;
      feedbackEl.style.color = 'red';
    }
    updateScoreTime();
    nextBtn.disabled = false;
  }

  // Show the correct answer without guessing
  showAnswerBtn.addEventListener('click', () => {
    if(gameOver || answered) return;
    const correctColour = species_colours[species[currentIndex]];
    feedbackEl.textContent = `The correct answer was: ${correctColour}`;
    feedbackEl.style.color = 'orange';
    showAnswerBtn.disabled = true;
    nextBtn.disabled = false;
    questionsAnswered++;
    ionEl.setAttribute('draggable', 'false');  // disable dragging after show answer
    answered = true;
    ionSelectedForSnap = false;
    ionEl.classList.remove('selected');
    dropzonesEl.childNodes.forEach(dz => dz.classList.remove('active'));
    updateScoreTime();
  });

  // Move to the next ion or finish game
  nextBtn.addEventListener('click', () => {
    currentIndex++;
    if(currentIndex >= species.length) {
      gameOver = true;
      feedbackEl.innerHTML = `🎉 You've matched all the species! Total time: ${getTotalElapsedTime()} seconds.`;
      ionEl.textContent = '';
      ionEl.style.display = 'none';
      showAnswerBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      tryAgainBtn.style.display = 'inline-block';
      stopTotalElapsedTimer();
      updateScoreTime();
    } else {
      setCurrentIon();
    }
  });

  // Reset game state
  tryAgainBtn.addEventListener('click', () => {
    species = Object.keys(species_colours);
    shuffle(species);
    currentIndex = 0;
    score = 0;
    questionsAnswered = 0;
    gameOver = false;
    tryAgainBtn.style.display = 'none';
    showAnswerBtn.style.display = 'inline-block';
    nextBtn.style.display = 'inline-block';
    totalStartTime = null;
    ionSelectedForSnap = false;
    setCurrentIon();
    updateScoreTime();
    feedbackEl.textContent = '';
  });

  // Update score and time text (time is total elapsed)
  function updateScoreTime() {
    scoreTimeEl.textContent = `Score: ${score} / ${questionsAnswered} | Time: ${getTotalElapsedTime()}s`;
  }

  // Total elapsed time functions
  function getTotalElapsedTime() {
    if(!totalStartTime) return 0;
    return Math.floor((Date.now() - totalStartTime) / 1000);
  }
  function startTotalElapsedTimer() {
    if(totalElapsedInterval) clearInterval(totalElapsedInterval);
    totalElapsedInterval = setInterval(() => {
      updateScoreTime();
    }, 1000);
  }
  function stopTotalElapsedTimer() {
    if(totalElapsedInterval) {
      clearInterval(totalElapsedInterval);
      totalElapsedInterval = null;
    }
  }

  // Initialize
  shuffle(species);
  setupDropzones();
  setCurrentIon();
  updateScoreTime();
</script>

</body>
</html>
